<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Threat Detection Graph</title>
  <style>
    /* Basic styling */
    svg {
      border: 1px solid #ccc;
    }
    .node circle {
      stroke: #fff;
      stroke-width: 1.5px;
    }
    .link {
      stroke: #999;
      stroke-opacity: 0.6;
    }
    text {
      font-family: sans-serif;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <svg width="960" height="600"></svg>

  <!-- Include D3.js -->
  <script src="https://d3js.org/d3.v6.min.js"></script>

  <script>
    // Fetch data from the backend API
    fetch('http://localhost:5001/api/threat_scenarios')
      .then(response => response.json())
      .then(data => {
        console.log('Data received:', data);

        // Transform data into nodes and links
        const nodes = [];
        const links = [];

        data.forEach(ts => {
          nodes.push({ id: ts.id, name: ts.name, group: 'ThreatScenario' });

          if (Array.isArray(ts.techniques) && ts.techniques.length > 0) {
            ts.techniques.forEach(technique => {
              nodes.push({ id: technique.id, name: technique.name, group: 'Technique' });
              links.push({ source: ts.id, target: technique.id });
            });
          } else {
            console.warn(`No techniques found for threat scenario: ${ts.name}`);
          }
        });

        // Remove duplicate nodes
        const uniqueNodes = Array.from(new Map(nodes.map(node => [node.id, node])).values());

        // If there are no nodes or links, display a message
        if (uniqueNodes.length === 0 || links.length === 0) {
          console.warn('No data to display.');
          const svg = d3.select("svg");
          svg.append("text")
            .attr("x", 50)
            .attr("y", 50)
            .text("No data available to display.")
            .attr("font-size", "24px")
            .attr("fill", "red");
          return;
        }

        // Create D3 simulation
        const svg = d3.select("svg");
        const width = +svg.attr("width");
        const height = +svg.attr("height");

        const simulation = d3.forceSimulation(uniqueNodes)
          .force("link", d3.forceLink(links).id(d => d.id).distance(200))
          .force("charge", d3.forceManyBody().strength(-300))
          .force("center", d3.forceCenter(width / 2, height / 2));

        // Draw links
        const link = svg.append("g")
          .attr("class", "links")
          .selectAll("line")
          .data(links)
          .enter().append("line")
          .attr("class", "link");

        // Draw nodes
        const node = svg.append("g")
          .attr("class", "nodes")
          .selectAll("circle")
          .data(uniqueNodes)
          .enter().append("circle")
          .attr("r", 10)
          .attr("fill", d => d.group === 'ThreatScenario' ? '#ff7f0e' : '#1f77b4')
          .call(drag(simulation));

        // Add labels
        const label = svg.append("g")
          .attr("class", "labels")
          .selectAll("text")
          .data(uniqueNodes)
          .enter().append("text")
          .attr("dy", -15)
          .attr("text-anchor", "middle")
          .text(d => d.name);

        // Update positions on tick
        simulation.on("tick", () => {
          link
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);

          node
            .attr("cx", d => d.x)
            .attr("cy", d => d.y);

          label
            .attr("x", d => d.x)
            .attr("y", d => d.y);
        });

        // Drag functionality
        function drag(simulation) {
          function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
          }

          function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
          }

          function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
          }

          return d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended);
        }
      })
      .catch(error => {
        console.error('Error fetching data:', error);
        const svg = d3.select("svg");
        svg.append("text")
          .attr("x", 50)
          .attr("y", 50)
          .text("Failed to load data.")
          .attr("font-size", "24px")
          .attr("fill", "red");
      });
  </script>
</body>
</html>